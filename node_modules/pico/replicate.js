// Generated by CoffeeScript 1.6.3
(function() {
  var couchdb_rewrite_url, log_error, replicate, replicator, request;

  request = require('request');

  couchdb_rewrite_url = require('./couchdb_rewrite_url');

  replicator = 'http://127.0.0.1:5984/_replicate';

  log_error = function(e) {
    if (e != null) {
      return console.log(e);
    }
  };

  replicate = function(source_uri, target_uri, replicate_interval, filter, params) {
    var default_replicate_interval, minutes, start_replication;
    if (source_uri == null) {
      console.log("source_uri is required, not replicating");
      return;
    }
    if (target_uri == null) {
      console.log("target_uri is required, not replicating");
      return;
    }
    start_replication = function() {
      var replicant;
      replicant = {
        source: couchdb_rewrite_url(source_uri),
        target: couchdb_rewrite_url(target_uri),
        continuous: true
      };
      if (filter != null) {
        replicant.filter = filter;
      }
      if (params != null) {
        replicant.query_params = params;
      }
      return request.post(replicator, {
        json: replicant
      }, log_error);
    };
    minutes = 60 * 1000;
    default_replicate_interval = 5 * minutes;
    if (replicate_interval == null) {
      replicate_interval = default_replicate_interval;
    }
    start_replication();
    return setInterval(start_replication, replicate_interval);
  };

  module.exports = replicate;

}).call(this);
